## cow lab

### 实现

维护一个物理页的引用计数数组，只有引用为0时，`kfree`才释放物理页。

在`uvmcopy`中不要申请新页面，只拷贝页表项，将拷贝和被拷贝的页表项都置为只读，增加对应物理页的引用计数。

只处理load指令的page fault，检测地址范围是否在p->sz以内。如果是，申请新页面，拷贝旧页面上去，重新映射。可以用uvmunmap释放旧页面，再uvmmap。



### 注意事项

由于多CPU下可能同时访问物理地址，导致需要同时读取或修改引用计数，对计数数组操作时一定要**加锁**。我把计数数组放在kmem里面，再kalloc.c中添加接口提供给外面加锁后地址增加计数的功能。如果涉及根据读取计数然后修改计数的操作，一定要确保读取然后修改是**一个原子操作**，否则可能出现读取完后被其它CPU修改，导致读到的数据是脏数据。

确保计数不要多减多加。增加一个判断计数是否小于0的assert可以便于调试。在我这里，uvunmap设置参数dofree为1时就会调用kfree减少计数了，不要再kfree一次了。

### 总结
难度可以，代码量很少。如果要和lazy allocation结合起来，就要额外设置cow页的RSW位来区分这个页是cow页还是lazy页。
